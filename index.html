<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="style.css">
  <title>Digital Bulletin Board</title>
</head>
<body>
    <div id="seal-header" class="full-width align-center">
      <img src="NYC_seal.png">
      <h2 class="align-center"><u>NEW YORK CITY COUNCIL</u></h2>
      <p class="align-right" id="today"></p>
    </div>
    <div id="agenda-container"></div>
</body>
<script src="jquery-3.3.1.min.js"></script>
<script async>
  const apiToken = "Uvxb0j9syjm3aI8h46DhQvnX5skN4aSUL0x_Ee3ty9M.ew0KICAiVmVyc2lvbiI6IDEsDQogICJOYW1lIjogIk5ZQyByZWFkIHRva2VuIDIwMTcxMDI2IiwNCiAgIkRhdGUiOiAiMjAxNy0xMC0yNlQxNjoyNjo1Mi42ODM0MDYtMDU6MDAiLA0KICAiV3JpdGUiOiBmYWxzZQ0KfQ"
  Date.prototype.stdTimezoneOffset = function() {
    var jan = new Date(this.getFullYear(), 0, 1);
    var jul = new Date(this.getFullYear(), 6, 1);
    return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
  }
  Date.prototype.dst = function() {
    return this.getTimezoneOffset() < this.stdTimezoneOffset();
  }
  var date;
  new Date().dst() ?  date = new Date(new Date().getTime() - 4 * 3600 * 1000) : date = new Date(new Date().getTime() - 5 * 3600 * 1000)
  var month31 = [1,3,5,7,8,10,12], month30 = [4,6,9,11], startDate, endDate, startYear = date.getFullYear(), startMonth = date.getMonth()+1, startDay = date.getDate(), nowHour = date.getUTCHours(), nowMinute = date.getUTCMinutes(), midDay, meetingHour, meetingMinute, endYear, endMonth, endDay, agendaLink;
  
  $("#today").html(date.toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}));

  var addZero = function(n) {return (n < 10) ? ("0" + n) : n;}
  if(startMonth === 12 && startDay === 31){ // if start day is NYE. Unlikely.
    endYear = startYear+1;
    endMonth = 1;
    endDay = 1;
  } else if (startYear%4 !== 0 && startMonth === 2 && startDay === 28){ //if last day of Feb in normal year
    endYear = startYear;
    endMonth = 3;
    endDay = 1;
  } else if (startYear%4 === 0 && startMonth === 2 && startDay === 29){ //if last day of Feb in leap year
    endYear = startYear;
    endMonth = 3;
    endDay = 1;
  } else if ((month31.indexOf(startMonth) !== -1) && startDay === 31){ //if start day is 31st day of month
    endYear = startYear;
    endMonth = startMonth+1;
    endDay = 1;
  } else if ((month30.indexOf(startMonth) !== -1) && startDay === 30){ //if start day is 30th day of month
    endYear = startYear;
    endMonth = startMonth+1;
    endDay = 1;
  } else { //any other day
    endYear = startYear;
    endMonth = startMonth;
    endDay = startDay+1;
  };

  startDate = startYear+"-"+addZero(startMonth)+"-"+addZero(startDay);
  endDate = endYear+"-"+addZero(endMonth)+"-"+addZero(endDay);

  $.ajax({
    type:"GET",
    async:true,
    dataType: "jsonp",
    url:"https://webapi.legistar.com/v1/nyc/events?token="+apiToken+"&$filter=EventDate+ge+datetime%27"+startDate+"%27&$orderby=EventDate+asc",
    success:function(hearings){
      function timeConverter(timeString){
        var hr = parseInt(timeString.split(" ")[0].split(":")[0]);
        var min = parseInt(timeString.split(" ")[0].split(":")[1]);
        var ampm = timeString.split(" ")[1];
        ampm.toLowerCase() === "am" || (ampm.toLowerCase() === "pm" && hr === 12) ? hr = hr * 100 : hr = (hr+12) * 100;
        return hr+min;
      };
      // var sortedHearings = hearings.sort(function(a,b){
      //   return timeConverter(a.EventTime) - timeConverter(b.EventTime);
      // });
      $("#committee-loader").remove();
      hearings.forEach(function(hearing){
        // debugger
        midDay = hearing.EventTime.split(" ")[1];
        meetingHour = parseInt(hearing.EventTime.split(" ")[0].split(":")[0]);
        meetingMinute = parseInt(hearing.EventTime.split(" ")[0].split(":")[1]);
        midDay === "PM" && meetingHour !== 12 ? meetingHour += 12 : meetingHour;
        hearing.EventAgendaFile !== null ? agendaLink = hearing.EventAgendaFile : agendaLink = "#";
        hearingDate = new Date(hearing.EventDate.split("T")[0].split("-")[0],hearing.EventDate.split("T")[0].split("-")[1]-1,hearing.EventDate.split("T")[0].split("-")[2]).toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
        if (hearing.EventAgendaStatusName.toLowerCase() !== "draft"){
          if(hearing.EventAgendaStatusName.toLowerCase() === "deferred"){
            // $("#agenda-container").append("<div class='agenda'><p class='align-center hdate'>"+hearingDate+"</p><table class='full-width'><tr><td class='align-left hbody'>"+hearing.EventBodyName+"</td><td class='align-right hchair' data-body-id="+hearing.EventBodyId+"></td></tr><tr><td colspan=2 class='align-left heventItems'><iframe width='100%' src='"+hearing.EventAgendaFile+"'></iframe></td></tr><tr><td class='align-left hlocation'>"+hearing.EventLocation+"</td><td class='align-right htime'><s>"+hearing.EventTime+"</s> Deferred</td></tr></table></div>");
            $("#agenda-container").append("<div class='agenda'><p class='align-center hdate'>"+hearingDate+"</p><table class='full-width'><tr><td class='align-left hbody'><span>"+hearing.EventBodyName+"</span></td><td class='align-right hchair' data-body-id="+hearing.EventBodyId+"></td></tr><tr><td colspan=2 id='heventid-"+hearing.EventId+"' class='align-left heventItems' data-event-id="+hearing.EventId+"></td></tr><tr><td class='align-left hlocation'><span>"+hearing.EventLocation+"</span></td><td class='align-right htime'><span><s>"+hearing.EventTime+"</s> Deferred</span></td></tr></table></div>");
          } else {
            $("#agenda-container").append("<div class='agenda'><p class='align-center hdate'>"+hearingDate+"</p><table class='full-width'><tr><td class='align-left hbody'><span>"+hearing.EventBodyName+"</span></td><td class='align-right hchair' data-body-id="+hearing.EventBodyId+"></td></tr><tr><td colspan=2 id='heventid-"+hearing.EventId+"' class='align-left heventItems' data-event-id="+hearing.EventId+"></td></tr><tr><td class='align-left hlocation'><span>"+hearing.EventLocation+"</span></td><td class='align-right htime'><span>"+hearing.EventTime+"</span></td></tr></table></div>");
          };
        }
      });
    },
    complete: function(){
      $(".heventItems").each(function(){
        var $list = $("<ul class='event-item-list'>");
        $.ajax({
          type:"GET",
          dataType: "jsonp",
          url:"https://webapi.legistar.com/v1/nyc/events/"+$(this).attr("data-event-id")+"/eventitems?token="+apiToken,
          success: function(items){
            items.forEach(function(item){
              if(item.EventItemMatterFile === null){
                $list.append("<li><strong>"+item.EventItemTitle+"</strong>");
              } else {
                $list.append("<li><strong>"+item.EventItemMatterFile+"</strong> - "+item.EventItemTitle+"</li>");
              };
            });
          },
          complete: function(){
            $(".event-item-list").each(function(){
              if($(this).height() < 150){

              } else {
                $(this).addClass("scrollable");
              };
            });
          }
        });
        $(this).append($list);
      });
      $(".hchair").each(function(){
        $.ajax({
          type:"GET",
          dataType: "jsonp",
          url:"https://webapi.legistar.com/v1/nyc/Bodies/"+$(this).attr("data-body-id")+"?token="+apiToken,
          success:function(body){
            if (body.BodyId !== 1){
              $("td[data-body-id='"+body.BodyId+"']").html("<span><strong>"+body.BodyContactFullName.trim() + "</strong>, Chairperson</span>");
            } else {
              $("td[data-body-id='"+body.BodyId+"']").html("<span>Stated Meeting</span>");
            };
          }
        });
      });
    }
  });





  var today = new Date();
  var voteStart = new Date(2018,03,07);
  var voteEnd = new Date(2018,03,16);
  console.log(today)
  console.log("Is today before vote week? "+ (+today < +voteStart ? "Yes" : "No"))
  console.log("Is today after vote week? "+ (+today > +voteEnd ? "Yes" : "No"))
  console.log("Is today between vote week? "+ ((+today > +voteStart && +today < +voteEnd) ? "Yes" : "No"))
</script>
</html>